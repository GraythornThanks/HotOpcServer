{% extends 'base.html' %}
{% load static %}

{% block title %}节点管理{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
    [v-cloak] {
        display: none;
    }
    .restart-alert {
        display: none;
    }
    .restart-alert.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div id="app" v-cloak>
    <div class="container mt-4">
        <!-- 重启提示 -->
        <div class="alert alert-warning restart-alert" :class="{ show: needsRestart }">
            <i class="bi bi-exclamation-triangle"></i>
            您已修改了节点配置，需要重启服务器才能生效。
            <button class="btn btn-warning btn-sm ms-3" @click="restartServer" :disabled="isRestarting">
                <i class="bi bi-arrow-clockwise"></i>
                [[ isRestarting ? '重启中...' : '立即重启' ]]
            </button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h2>OPC UA节点管理</h2>
                <span :class="serverStatusClass">服务器状态: [[ serverStatus ]]</span>
            </div>
            <div>
                <button class="btn btn-primary" @click="showAddNodeModal">
                    <i class="bi bi-plus"></i> 添加节点
                </button>
                <a href="{% url 'server-start' %}" class="btn btn-success" :class="{ disabled: serverRunning }">
                    <i class="bi bi-play-fill"></i> 启动服务器
                </a>
                <button class="btn btn-warning" @click="restartServer" :disabled="isRestarting || !serverRunning">
                    <i class="bi bi-arrow-clockwise"></i>
                    [[ isRestarting ? '重启中' : '重启服务器' ]]
                </button>
                <a href="{% url 'server-stop' %}" class="btn btn-danger" :class="{ disabled: !serverRunning }">
                    <i class="bi bi-stop-fill"></i> 停止服务器
                </a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>节点类型</th>
                                <th>数据类型</th>
                                <th>节点ID</th>
                                <th>值</th>
                                <th>描述</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="node in nodes" :key="node.id">
                                <td>[[ node.name ]]</td>
                                <td>[[ getNodeTypeDisplay(node.node_type) ]]</td>
                                <td>[[ getDataTypeDisplay(node.data_type) ]]</td>
                                <td>[[ node.node_id ]]</td>
                                <td>[[ node.value || '-' ]]</td>
                                <td>[[ node.description || '-' ]]</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-info" @click="editNode(node)">
                                            <i class="bi bi-pencil"></i> 编辑
                                        </button>
                                        <button class="btn btn-sm btn-danger" @click="confirmDelete(node)">
                                            <i class="bi bi-trash"></i> 删除
                                        </button>
                                        <span v-if="node.variation_type !== 'none'" 
                                              class="badge bg-primary" 
                                              :title="'变化类型: ' + getVariationTypeDisplay(node.variation_type) + '\n间隔: ' + node.variation_interval + 'ms'">
                                            <i class="bi bi-arrow-repeat"></i>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                            <tr v-if="nodes.length === 0">
                                <td colspan="7" class="text-center">暂无节点数据</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 节点编辑模态框 -->
    <div class="modal fade" id="nodeModal" tabindex="-1" ref="nodeModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">[[ isEditMode ? '编辑节点' : '添加节点' ]]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="saveNode" id="nodeForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">名称</label>
                            <input type="text" class="form-control" id="name" v-model="currentNode.name" required>
                        </div>
                        <div class="mb-3">
                            <label for="nodeType" class="form-label">节点类型</label>
                            <select class="form-control" id="nodeType" v-model="currentNode.node_type" 
                                    :disabled="isEditMode">
                                <option v-for="type in nodeTypes" :key="type.value" :value="type.value">
                                    [[ type.label ]]
                                </option>
                            </select>
                        </div>
                        <div class="mb-3" v-if="currentNode.node_type === 'variable'">
                            <label for="dataType" class="form-label">数据类型</label>
                            <select class="form-control" id="dataType" v-model="currentNode.data_type" 
                                    :disabled="isEditMode">
                                <option v-for="type in dataTypes" :key="type.value" :value="type.value">
                                    [[ type.label ]]
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="nodeIdentifier" class="form-label">节点ID</label>
                            <input type="text" class="form-control" id="nodeIdentifier" 
                                   v-model="currentNode.node_id" required 
                                   :disabled="isEditMode"
                                   :class="{ 'is-invalid': nodeIdError }"
                                   @input="checkNodeIdExists(currentNode.node_id)">
                            <div class="invalid-feedback" v-if="nodeIdError">
                                [[ nodeIdError ]]
                            </div>
                            <small class="form-text text-muted">格式示例: ns=1;i=1000</small>
                        </div>
                        <div class="mb-3" v-if="currentNode.node_type === 'variable'">
                            <label for="value" class="form-label">值</label>
                            <input type="text" class="form-control" id="value" v-model="currentNode.value">
                            <small class="form-text text-muted">[[ valueHint ]]</small>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">描述</label>
                            <textarea class="form-control" id="description" rows="3" 
                                      v-model="currentNode.description"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="variationType" class="form-label">变化类型</label>
                            <select class="form-control" id="variationType" v-model="currentNode.variation_type">
                                <option v-for="type in variationTypes" :key="type.value" :value="type.value">
                                    [[ type.label ]]
                                </option>
                            </select>
                        </div>

                        <!-- 变化配置 -->
                        <template v-if="currentNode.variation_type !== 'none'">
                            <div class="mb-3" v-if="['random', 'linear', 'cycle'].includes(currentNode.variation_type)">
                                <div class="row">
                                    <div class="col">
                                        <label for="variationMin" class="form-label">最小值</label>
                                        <input type="number" class="form-control" id="variationMin" 
                                               v-model="currentNode.variation_min" step="any">
                                    </div>
                                    <div class="col">
                                        <label for="variationMax" class="form-label">最大值</label>
                                        <input type="number" class="form-control" id="variationMax" 
                                               v-model="currentNode.variation_max" step="any">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3" v-if="['linear', 'cycle'].includes(currentNode.variation_type)">
                                <label for="variationStep" class="form-label">变化步长</label>
                                <input type="number" class="form-control" id="variationStep" 
                                       v-model="currentNode.variation_step" step="any">
                            </div>
                            <div class="mb-3" v-if="currentNode.variation_type === 'discrete'">
                                <label for="variationValues" class="form-label">离散值集合</label>
                                <input type="text" class="form-control" id="variationValues" 
                                       v-model="currentNode.variation_values" 
                                       placeholder="例如：[1, 2, 3, 4]">
                                <small class="form-text text-muted">输入JSON格式的数组</small>
                            </div>
                            <div class="mb-3">
                                <label for="variationInterval" class="form-label">变化间隔(毫秒)</label>
                                <input type="number" class="form-control" id="variationInterval" 
                                       v-model="currentNode.variation_interval" min="100">
                                <small class="form-text text-muted">最少100毫秒</small>
                            </div>
                        </template>

                        <!-- 规则预设 -->
                        <div class="mb-3">
                            <label class="form-label">快速规则</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        v-for="(rule, key) in rulePresets" 
                                        :key="key"
                                        @click="applyRulePreset(key)">
                                    <i :class="rule.icon"></i> [[ rule.name ]]
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="saveNode">保存</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue

const app = createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            nodes: [],
            currentNode: this.getEmptyNode(),
            isEditMode: false,
            modal: null,
            refreshInterval: null,
            serverRunning: false,
            needsRestart: false,
            isRestarting: false,
            nodeTypes: [
                { value: 'variable', label: '变量' },
                { value: 'object', label: '对象' },
                { value: 'method', label: '方法' }
            ],
            dataTypes: [
                { value: 'double', label: '双精度浮点数(Double)' },
                { value: 'float', label: '单精度浮点数(Float)' },
                { value: 'int32', label: '32位整数(Int32)' },
                { value: 'int64', label: '64位整数(Int64)' },
                { value: 'uint16', label: '无符号16位整数(UInt16)' },
                { value: 'uint32', label: '无符号32位整数(UInt32)' },
                { value: 'uint64', label: '无符号64位整数(UInt64)' },
                { value: 'boolean', label: '布尔值(Boolean)' },
                { value: 'string', label: '字符串(String)' },
                { value: 'datetime', label: '日期时间(DateTime)' },
                { value: 'bytestring', label: '字节串(ByteString)' },
                { value: 'array', label: '数组(Array)' }
            ],
            variationTypes: [
                { value: 'none', label: '不变化' },
                { value: 'random', label: '随机变化' },
                { value: 'linear', label: '线性变化' },
                { value: 'discrete', label: '离散变化' },
                { value: 'cycle', label: '循环变化' }
            ],
            rulePresets: {
                temperature: {
                    name: '温度',
                    icon: 'bi bi-thermometer-half',
                    type: 'linear',
                    min: 20,
                    max: 30,
                    step: 0.1,
                    interval: 1000,
                    description: '温度模拟(20-30℃)'
                },
                pressure: {
                    name: '压力',
                    icon: 'bi bi-speedometer',
                    type: 'random',
                    min: 0.8,
                    max: 1.2,
                    interval: 500,
                    description: '压力模拟(0.8-1.2MPa)'
                },
                flow: {
                    name: '流量',
                    icon: 'bi bi-wind',
                    type: 'random',
                    min: 10,
                    max: 20,
                    interval: 800,
                    description: '气体流量(10-20m³/h)'
                },
                current: {
                    name: '电流',
                    icon: 'bi bi-lightning',
                    type: 'random',
                    min: 4,
                    max: 20,
                    interval: 500,
                    description: '电流(4-20mA)'
                },
                voltage: {
                    name: '电压',
                    icon: 'bi bi-lightning-charge',
                    type: 'random',
                    min: 0,
                    max: 24,
                    interval: 500,
                    description: '电压(0-24V)'
                },
                power: {
                    name: '功率',
                    icon: 'bi bi-plug',
                    type: 'random',
                    min: 0,
                    max: 100,
                    interval: 1000,
                    description: '功率(0-100kW)'
                },
                deviation: {
                    name: '偏差',
                    icon: 'bi bi-percent',
                    type: 'random',
                    min: -5,
                    max: 5,
                    interval: 1000,
                    description: '偏差(-5%~+5%)'
                },
                humidity: {
                    name: '湿度',
                    icon: 'bi bi-droplet-half',
                    type: 'random',
                    min: 30,
                    max: 70,
                    interval: 2000,
                    description: '湿度(30-70%)'
                },
                alarm: {
                    name: '报警',
                    icon: 'bi bi-exclamation-triangle',
                    type: 'discrete',
                    values: '[0, 1, 2]',
                    interval: 5000,
                    description: '报警状态(0:正常,1:警告,2:报警)'
                },
                switch: {
                    name: '开关',
                    icon: 'bi bi-toggle-on',
                    type: 'discrete',
                    values: '[0, 1]',
                    interval: 1500,
                    description: '开关状态(0:关闭,1:开启)'
                },
                counter: {
                    name: '计数器',
                    icon: 'bi bi-plus-circle',
                    type: 'cycle',
                    min: 0,
                    max: 999999,
                    step: 1,
                    interval: 1000,
                    description: '计数器(0-999999循环)'
                },
                sine: {
                    name: '正弦波',
                    icon: 'bi bi-graph-up',
                    type: 'linear',
                    min: -1,
                    max: 1,
                    step: 0.1,
                    interval: 100,
                    description: '正弦波模拟(-1到1)'
                }
            },
            nodeIdError: '',
            isCheckingNodeId: false
        }
    },
    computed: {
        valueHint() {
            if (!this.currentNode.node_type === 'variable') return ''
            
            const dataType = this.currentNode.data_type
            const variationType = this.currentNode.variation_type
            let hint = '请输入'
            
            if (variationType === 'cycle') {
                hint += '起始值（将在范围内循环变化）'
            } else {
                switch(dataType) {
                    case 'double':
                    case 'float':
                        hint += '数字（可包含小数点）'
                        break
                    case 'int32':
                    case 'int64':
                    case 'uint16':
                    case 'uint32':
                    case 'uint64':
                        hint += '��数'
                        break
                    case 'boolean':
                        hint += 'true或false'
                        break
                    case 'datetime':
                        hint += 'ISO格式的日期时间'
                        break
                    case 'array':
                        hint += 'JSON格式的数组'
                        break
                }
            }
            return hint
        },
        serverStatus() {
            return this.serverRunning ? '运行中' : '已停止'
        },
        serverStatusClass() {
            return {
                'badge': true,
                'bg-success': this.serverRunning,
                'bg-danger': !this.serverRunning
            }
        }
    },
    methods: {
        getEmptyNode() {
            return {
                id: null,
                name: '',
                node_type: 'variable',
                data_type: 'double',
                node_id: '',
                value: '',
                description: '',
                variation_type: 'none',
                variation_interval: 1000,
                variation_min: null,
                variation_max: null,
                variation_step: null,
                variation_values: null
            }
        },
        async loadNodes() {
            try {
                const response = await fetch('/node/list/')
                const data = await response.json()
                if (data.success) {
                    this.nodes = data.nodes
                } else {
                    alert('加载节点失败: ' + data.error)
                }
            } catch (error) {
                console.error('Error loading nodes:', error)
                alert('加载节点失败')
            }
        },
        showAddNodeModal() {
            this.isEditMode = false
            this.currentNode = this.getEmptyNode()
            this.nodeIdError = ''
            this.modal.show()
        },
        editNode(node) {
            this.isEditMode = true
            this.currentNode = { ...node }
            this.nodeIdError = ''
            this.modal.show()
        },
        async saveNode() {
            if (!this.serverRunning && this.currentNode.node_type === 'variable') {
                if (!confirm('OPC UA服务器未运行，节点将只保存在数据库中。是否继续？')) {
                    return
                }
            }
            
            try {
                if (!this.isEditMode) {
                    const exists = await this.checkNodeIdExists(this.currentNode.node_id)
                    if (exists || this.nodeIdError) {
                        return
                    }
                }
                
                const url = this.isEditMode ? `/node/${this.currentNode.id}/edit/` : '/node/add/'
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(this.currentNode)
                })
                const data = await response.json()
                if (data.success) {
                    this.modal.hide()
                    await this.loadNodes()
                    this.needsRestart = true
                    this.nodeIdError = ''
                } else {
                    if (data.error.includes('节点ID')) {
                        this.nodeIdError = data.error
                    } else {
                        alert('保存失败: ' + data.error)
                    }
                }
            } catch (error) {
                console.error('Error saving node:', error)
                alert('保存失败')
            }
        },
        async confirmDelete(node) {
            if (confirm('确定要删除这个节点吗？')) {
                try {
                    const response = await fetch(`/node/${node.id}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    })
                    const data = await response.json()
                    if (data.success) {
                        await this.loadNodes()
                        this.needsRestart = true
                    } else {
                        alert('删除失败: ' + data.error)
                    }
                } catch (error) {
                    console.error('Error deleting node:', error)
                    alert('删除失败')
                }
            }
        },
        applyRulePreset(key) {
            const rule = this.rulePresets[key]
            if (!rule) return

            this.currentNode.variation_type = rule.type
            this.currentNode.variation_interval = rule.interval

            if (['random', 'linear', 'cycle'].includes(rule.type)) {
                this.currentNode.variation_min = rule.min
                this.currentNode.variation_max = rule.max
                if (rule.type === 'linear' || rule.type === 'cycle') {
                    this.currentNode.variation_step = rule.step
                }
            } else if (rule.type === 'discrete') {
                this.currentNode.variation_values = rule.values
            }

            if (!this.currentNode.description) {
                this.currentNode.description = rule.description
            }

            if (!this.currentNode.value) {
                if (rule.type === 'discrete') {
                    try {
                        const values = JSON.parse(rule.values)
                        this.currentNode.value = values[0]
                    } catch (e) {}
                } else {
                    this.currentNode.value = rule.min
                }
            }
        },
        getNodeTypeDisplay(type) {
            return this.nodeTypes.find(t => t.value === type)?.label || type
        },
        getDataTypeDisplay(type) {
            return this.dataTypes.find(t => t.value === type)?.label || type
        },
        getVariationTypeDisplay(type) {
            return this.variationTypes.find(t => t.value === type)?.label || type
        },
        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value
        },
        async refreshNodeValues() {
            try {
                const response = await fetch('/node/list/')
                const data = await response.json()
                if (data.success) {
                    this.nodes = data.nodes
                    this.serverRunning = data.server_running
                    
                    if (!this.serverRunning) {
                        console.warn('OPC UA Server is not running')
                    }
                }
            } catch (error) {
                console.error('Error refreshing node values:', error)
            }
        },
        startAutoRefresh() {
            this.refreshInterval = setInterval(() => {
                this.refreshNodeValues()
            }, 1000)
        },
        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval)
                this.refreshInterval = null
            }
        },
        async restartServer() {
            if (!confirm('确定要重启服务器吗？这将会中断所有当前连接。')) {
                return
            }
            
            this.isRestarting = true
            try {
                await fetch('{% url "server-stop" %}', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                })
                
                await new Promise(resolve => setTimeout(resolve, 1000))
                
                await fetch('{% url "server-start" %}', {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                })
                
                this.needsRestart = false
                await this.loadNodes()
                alert('服务器已重启完成')
            } catch (error) {
                console.error('Error restarting server:', error)
                alert('重启服务器失败')
            } finally {
                this.isRestarting = false
            }
        },
        async checkNodeIdExists(nodeId) {
            if (!nodeId) return false;
            
            this.isCheckingNodeId = true;
            this.nodeIdError = '';
            
            try {
                if (!this.validateNodeId(nodeId)) {
                    this.nodeIdError = '节点ID格式无效，正确格式如：ns=1;i=1000';
                    return true;
                }
                
                const existingNode = this.nodes.find(node => node.node_id === nodeId);
                if (existingNode) {
                    this.nodeIdError = '节点ID已存在';
                    return true;
                }
                
                return false;
            } finally {
                this.isCheckingNodeId = false;
            }
        },
        
        validateNodeId(nodeId) {
            const pattern = /^ns=\d+;[is]=\d+$/;
            return pattern.test(nodeId);
        }
    },
    mounted() {
        this.modal = new bootstrap.Modal(this.$refs.nodeModal)
        this.loadNodes()
        this.startAutoRefresh()
    },
    beforeUnmount() {
        this.stopAutoRefresh()
    }
})

app.mount('#app')
</script>
{% endblock %} 