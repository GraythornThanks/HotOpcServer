{% extends 'base.html' %}

{% block extra_css %}
<style>
    /* 主题颜色 */
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --info-color: #0dcaf0;
        --light-bg: #f8f9fa;
        --border-color: #dee2e6;
    }

    /* 状态总览面板 */
    .status-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .status-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .status-card:hover {
        transform: translateY(-2px);
    }

    .status-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .status-icon.running {
        background-color: rgba(25, 135, 84, 0.1);
        color: var(--success-color);
    }

    .status-icon.stopped {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }

    .status-icon.total {
        background-color: rgba(13, 110, 253, 0.1);
        color: var(--primary-color);
    }

    .status-icon.nodes {
        background-color: rgba(13, 202, 240, 0.1);
        color: var(--info-color);
    }

    .status-info {
        flex: 1;
    }

    .status-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .status-value {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 0;
    }

    /* 服务器卡片样式 */
    .server-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .server-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
    }

    .server-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .server-card.active {
        border-color: var(--primary-color);
        background-color: rgba(13, 110, 253, 0.05);
    }

    .server-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .server-card .server-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .server-card .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .server-card .status-indicator.running {
        background-color: var(--success-color);
    }

    .server-card .status-indicator.stopped {
        background-color: var(--danger-color);
    }

    .server-card .card-body {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .server-card .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .server-card .card-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    /* 工具栏样式 */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
    }

    .toolbar .btn-group {
        display: flex;
        gap: 0.5rem;
    }

    /* 加载动画 */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    /* 表格样式 */
    .table-container {
        position: relative;
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }

    .table th {
        background-color: var(--light-bg);
        font-weight: 600;
    }

    /* 空状态样式 */
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    /* 批量操作工具栏 */
    .batch-actions {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
        align-items: center;
    }

    .batch-actions .selected-count {
        margin-right: auto;
        font-weight: 500;
        color: #6c757d;
    }

    /* 服务器高级选项 */
    .advanced-options {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--border-color);
    }

    .advanced-options-toggle {
        color: #6c757d;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .advanced-options-toggle:hover {
        color: var(--primary-color);
    }

    .advanced-options-toggle i {
        transition: transform 0.3s;
    }

    .advanced-options-toggle.expanded i {
        transform: rotate(180deg);
    }

    /* 服务器状态标签 */
    .server-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .server-status-badge.running {
        background-color: rgba(25, 135, 84, 0.1);
        color: var(--success-color);
    }

    .server-status-badge.stopped {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
    }

    .server-status-badge.warning {
        background-color: rgba(255, 193, 7, 0.1);
        color: var(--warning-color);
    }

    /* 服务器测试结果 */
    .test-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 8px;
        display: none;
    }

    .test-result.success {
        background-color: rgba(25, 135, 84, 0.1);
        color: var(--success-color);
        display: block;
    }

    .test-result.error {
        background-color: rgba(220, 53, 69, 0.1);
        color: var(--danger-color);
        display: block;
    }

    /* 导入/导出按钮 */
    .import-export-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .import-export-buttons .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Toast 通知样式 */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
    }

    .toast {
        min-width: 250px;
        margin-bottom: 10px;
        background-color: white;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
    }

    .toast.show {
        opacity: 1;
    }

    .toast.success {
        border-left: 4px solid var(--success-color);
    }

    .toast.error {
        border-left: 4px solid var(--danger-color);
    }

    .toast-header {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background-color: rgba(255, 255, 255, 0.85);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .toast-body {
        padding: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div id="app" v-cloak>
    <!-- Toast 通知容器 -->
    <div class="toast-container">
        <div v-for="(toast, index) in toasts" :key="index"
             class="toast" :class="[toast.type, { show: toast.show }]">
            <div class="toast-header">
                <i class="bi me-2" :class="toast.type === 'success' ? 'bi-check-circle-fill text-success' : 'bi-x-circle-fill text-danger'"></i>
                <strong class="me-auto">${ toast.type === 'success' ? '成功' : '错误' }</strong>
                <button type="button" class="btn-close" @click="removeToast(index)"></button>
            </div>
            <div class="toast-body">
                ${ toast.message }
            </div>
        </div>
    </div>

    <!-- 状态总览 -->
    <div class="status-overview">
        <div class="status-card">
            <div class="status-icon total">
                <i class="bi bi-hdd-network"></i>
            </div>
            <div class="status-info">
                <div class="status-label">服务器总数</div>
                <div class="status-value">${ servers.length }</div>
            </div>
        </div>
        <div class="status-card">
            <div class="status-icon running">
                <i class="bi bi-play-circle"></i>
            </div>
            <div class="status-info">
                <div class="status-label">运行中服务器</div>
                <div class="status-value">${ servers.filter(s => s.is_running).length }</div>
            </div>
        </div>
        <div class="status-card">
            <div class="status-icon stopped">
                <i class="bi bi-stop-circle"></i>
            </div>
            <div class="status-info">
                <div class="status-label">已停止服务器</div>
                <div class="status-value">${ servers.filter(s => !s.is_running).length }</div>
            </div>
        </div>
        <div class="status-card">
            <div class="status-icon nodes">
                <i class="bi bi-diagram-3"></i>
            </div>
            <div class="status-info">
                <div class="status-label">节点总数</div>
                <div class="status-value">${ servers.reduce((sum, server) => sum + (server.node_count || 0), 0) }</div>
            </div>
        </div>
    </div>

    <!-- 服务器管理工具栏 -->
    <div class="toolbar">
        <h2 class="mb-0">OPC UA服务器管理</h2>
        <div class="btn-group">
            <button class="btn btn-primary" @click="showServerModal('add')">
                <i class="bi bi-plus-lg"></i>
                添加服务器
            </button>
            <button class="btn btn-info" @click="showImportModal">
                <i class="bi bi-upload"></i>
                导入配置
            </button>
            <button class="btn btn-secondary" @click="exportConfig">
                <i class="bi bi-download"></i>
                导出配置
            </button>
            <button class="btn btn-secondary" @click="refreshServers">
                <i class="bi bi-arrow-clockwise"></i>
                刷新状态
            </button>
        </div>
    </div>

    <!-- 批量操作工具栏 -->
    <div class="batch-actions" v-if="selectedServers.length > 0">
        <span class="selected-count">已选择 ${ selectedServers.length } 个服务器</span>
        <button class="btn btn-sm btn-success" @click="batchStartServers"
                :disabled="isProcessing">
            <i class="bi bi-play-fill"></i>
            批量启动
        </button>
        <button class="btn btn-sm btn-danger" @click="batchStopServers"
                :disabled="isProcessing">
            <i class="bi bi-stop-fill"></i>
            批量停止
        </button>
        <button class="btn btn-sm btn-danger" @click="confirmBatchDelete"
                :disabled="isProcessing">
            <i class="bi bi-trash"></i>
            批量删除
        </button>
    </div>

    <!-- 服务器卡片列表 -->
    <div class="server-cards">
        <div v-for="server in servers" :key="server.id" 
             class="server-card" :class="{ active: server.id === currentServer?.id }">
            <div class="card-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           v-model="server.selected"
                           @change="updateSelectedServers">
                    <h5 class="mb-0">${ server.name }</h5>
                </div>
                <div class="server-status">
                    <span class="status-indicator" :class="server.is_running ? 'running' : 'stopped'"></span>
                    <span>${ server.is_running ? '运行中' : '已停止' }</span>
                </div>
            </div>
            <div class="card-body">
                <div class="info-item">
                    <span>终端点：</span>
                    <span>${ server.endpoint }:${ server.port }</span>
                </div>
                <div class="info-item">
                    <span>节点数量：</span>
                    <span>${ server.node_count }</span>
                </div>
                <div class="info-item">
                    <span>创建时间：</span>
                    <span>${ new Date(server.created_at).toLocaleString('zh-CN') }</span>
                </div>
                <div class="info-item">
                    <span>最后更新：</span>
                    <span>${ new Date(server.updated_at).toLocaleString('zh-CN') }</span>
                </div>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary" 
                            @click="selectServer(server)"
                            :disabled="server.id === currentServer?.id">
                        <i class="bi bi-box-arrow-in-right"></i>
                        管理节点
                    </button>
                    <button class="btn btn-sm" 
                            :class="server.is_running ? 'btn-outline-danger' : 'btn-outline-success'"
                            @click="server.is_running ? stopServer(server) : startServer(server)"
                            :disabled="isProcessing">
                        <i class="bi" :class="server.is_running ? 'bi-stop-fill' : 'bi-play-fill'"></i>
                        ${ server.is_running ? '停止' : '启动' }
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" 
                            @click="showServerModal('edit', server)">
                        <i class="bi bi-gear"></i>
                        配置
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            @click="confirmDeleteServer(server)"
                            :disabled="server.is_running">
                        <i class="bi bi-trash"></i>
                        删除
                    </button>
                </div>
            </div>
        </div>

        <!-- 空状态提示 -->
        <div v-if="servers.length === 0" class="empty-state">
            <i class="bi bi-server"></i>
            <p>暂无服务器，点击"添加服务器"创建新的OPC UA服务器</p>
        </div>
    </div>

    <!-- 节点管理区域 -->
    <div v-if="currentServer" class="node-management">
        <div class="toolbar">
            <div class="d-flex align-items-center gap-3">
                <h3 class="mb-0">${ currentServer.name } - 节点管理</h3>
                <span class="badge" :class="currentServer.is_running ? 'bg-success' : 'bg-danger'">
                    ${ currentServer.is_running ? '运行中' : '已停止' }
                </span>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" @click="showNodeModal('add')"
                        :disabled="!currentServer.is_running">
                    <i class="bi bi-plus-lg"></i>
                    添加节点
                </button>
                <button class="btn btn-info" @click="showBatchAddModal"
                        :disabled="!currentServer.is_running">
                    <i class="bi bi-collection"></i>
                    批量添加
                </button>
                <button class="btn btn-secondary" @click="refreshNodes">
                    <i class="bi bi-arrow-clockwise"></i>
                    刷新
                </button>
            </div>
        </div>

        <!-- 节点列表 -->
        <div class="table-container">
            <div v-if="isLoading" class="loading-overlay">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>

            <table class="table table-hover mb-0" v-else>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>节点类型</th>
                        <th>数据类型</th>
                        <th>节点ID</th>
                        <th>值</th>
                        <th>描述</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="node in nodes" :key="node.id">
                        <td>${ node.name }</td>
                        <td>${ getNodeTypeDisplay(node.node_type) }</td>
                        <td>${ getDataTypeDisplay(node.data_type) }</td>
                        <td>${ node.node_id }</td>
                        <td>${ formatNodeValue(node) }</td>
                        <td>${ node.description || '-' }</td>
                        <td>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" @click="editNode(node)">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @click="confirmDeleteNode(node)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <span v-if="node.variation_type !== 'none'" 
                                  class="badge bg-info ms-2" 
                                  :title="'变化类型: ' + getVariationTypeDisplay(node.variation_type)">
                                <i class="bi bi-arrow-repeat"></i>
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- 空状态提示 -->
            <div v-if="!isLoading && nodes.length === 0" class="empty-state">
                <i class="bi bi-diagram-3"></i>
                <p>暂无节点数据，点击"添加节点"创建新的节点</p>
            </div>
        </div>
    </div>

    <!-- 服务器配置模态框 -->
    <div class="modal fade" id="serverModal" tabindex="-1" ref="serverModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        ${ serverAction === 'add' ? '添加服务器' : '编辑服务器' }
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="handleServerAction" id="serverForm" novalidate>
                        <!-- 基本配置 -->
                        <div class="mb-3">
                            <label for="serverName" class="form-label">服务器名称</label>
                            <input type="text" class="form-control" id="serverName" name="name"
                                   v-model="serverForm.name" required>
                            <div class="form-text">给服务器起一个容易识别的名称</div>
                        </div>
                        <div class="mb-3">
                            <label for="serverEndpoint" class="form-label">终端点</label>
                            <input type="text" class="form-control" id="serverEndpoint" name="endpoint"
                                   v-model="serverForm.endpoint" required>
                            <div class="form-text">服务器的IP地址或域名，例如：localhost 或 192.168.1.100</div>
                        </div>
                        <div class="mb-3">
                            <label for="serverPort" class="form-label">端口号</label>
                            <input type="number" class="form-control" id="serverPort" name="port"
                                   v-model="serverForm.port" min="1024" max="65535" required>
                            <div class="form-text">服务器监听的端口号，默认为4840</div>
                        </div>
                        <div class="mb-3">
                            <label for="serverUri" class="form-label">服务器URI</label>
                            <input type="text" class="form-control" id="serverUri" name="uri"
                                   v-model="serverForm.uri" required>
                            <div class="form-text">服务器的唯一标符，例如：urn:myserver</div>
                        </div>

                        <!-- 安全设 -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="allowAnonymous" name="allow_anonymous"
                                       v-model="serverForm.allow_anonymous">
                                <label class="form-check-label" for="allowAnonymous">
                                    允许匿名访问
                                </label>
                            </div>
                            <div class="form-text text-warning" v-if="serverForm.allow_anonymous">
                                <i class="bi bi-exclamation-triangle"></i>
                                警告：允许匿名访问可能存在安全风险
                            </div>
                        </div>
                        <div v-if="!serverForm.allow_anonymous">
                            <div class="mb-3">
                                <label for="username" class="form-label">用户名</label>
                                <input type="text" class="form-control" id="username" name="username"
                                       v-model="serverForm.username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密码</label>
                                <div class="input-group">
                                    <input :type="showPassword ? 'text' : 'password'" 
                                           class="form-control" id="password" name="password"
                                           v-model="serverForm.password" required>
                                    <button class="btn btn-outline-secondary" type="button"
                                            @click="showPassword = !showPassword">
                                        <i class="bi" :class="showPassword ? 'bi-eye-slash' : 'bi-eye'"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 高级选项 -->
                        <a href="#" class="advanced-options-toggle" 
                           :class="{ expanded: showAdvanced }"
                           @click.prevent="showAdvanced = !showAdvanced">
                            <i class="bi bi-chevron-down"></i>
                            高级选项
                        </a>
                        <div class="advanced-options" v-show="showAdvanced">
                            <div class="mb-3">
                                <label for="minSamplingInterval" class="form-label">
                                    最小采样间隔(ms)
                                </label>
                                <input type="number" class="form-control" id="minSamplingInterval" name="min_sampling_interval"
                                       v-model="serverForm.min_sampling_interval" min="100" required>
                                <div class="form-text">数据采样的最小时间间隔，建议不小于100ms</div>
                            </div>
                            <div class="mb-3">
                                <label for="maxConnections" class="form-label">
                                    最大连接数
                                </label>
                                <input type="number" class="form-control" id="maxConnections" name="max_connections"
                                       v-model="serverForm.max_connections" min="1">
                                <div class="form-text">允许的最大客户端连接数，默认不限制</div>
                            </div>
                            <div class="mb-3">
                                <label for="securityPolicy" class="form-label">
                                    安全策略
                                </label>
                                <select class="form-select" id="securityPolicy" name="security_policy"
                                        v-model="serverForm.security_policy">
                                    <option value="None">None - 无安全策略</option>
                                    <option value="Basic128Rsa15">Basic128Rsa15 - 基本RSA加密</option>
                                    <option value="Basic256">Basic256 - 256位基本加密</option>
                                    <option value="Basic256Sha256">Basic256Sha256 - SHA256加密</option>
                                </select>
                                <div class="form-text">选择服务器使用的安全策略</div>
                            </div>
                        </div>

                        <!-- 测试连接结果 -->
                        <div class="test-result" :class="testResult.status" v-if="testResult.message">
                            <i class="bi" :class="testResult.status === 'success' ? 'bi-check-circle' : 'bi-x-circle'"></i>
                            ${ testResult.message }
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-info" @click="testConnection"
                            :disabled="isProcessing || !isFormValid">
                        <i class="bi bi-lightning"></i>
                        测试连接
                    </button>
                    <button type="submit" form="serverForm" class="btn btn-primary"
                            :disabled="isProcessing || !isFormValid || (serverAction === 'add' && !testResult.success)">
                        ${ isProcessing ? '处理中...' : '确定' }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 导入配置模态框 -->
    <div class="modal fade" id="importModal" tabindex="-1" ref="importModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">导入服务器配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="configFile" class="form-label">选择配置文件</label>
                        <input type="file" class="form-control" id="configFile"
                               @change="handleFileSelect" accept=".json">
                        <div class="form-text">支持JSON格式的配置文件</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="overwrite"
                                   v-model="importOptions.overwrite">
                            <label class="form-check-label" for="overwrite">
                                覆盖同名服务器
                            </label>
                        </div>
                    </div>
                    <div v-if="importPreview.length > 0" class="mt-3">
                        <h6>导入预览</h6>
                        <ul class="list-group">
                            <li v-for="server in importPreview" :key="server.name"
                                class="list-group-item d-flex justify-content-between align-items-center">
                                ${ server.name }
                                <span class="server-status-badge" 
                                      :class="server.exists ? 'warning' : 'success'">
                                    ${ server.exists ? '已存在' : '新服务器' }
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="importConfig"
                            :disabled="!importPreview.length || isProcessing">
                        ${ isProcessing ? '导入中...' : '确认导入' }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 确认对话框 -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">${ confirmDialog.title }</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${ confirmDialog.message }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" @click="handleConfirm">确定</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const { createApp } = Vue;
    
    const app = createApp({
        delimiters: ['${', '}'],
        data() {
            return {
                servers: [],
                currentServer: null,
                nodes: [],
                isLoading: false,
                isProcessing: false,
                serverAction: 'add',
                serverForm: {
                    id: null,
                    name: '',
                    endpoint: '',
                    port: 4840,
                    uri: '',
                    allow_anonymous: true,
                    username: '',
                    password: '',
                    min_sampling_interval: 100,
                    max_connections: 0,
                    security_policy: 'None'
                },
                confirmDialog: {
                    title: '',
                    message: '',
                    callback: null
                },
                refreshInterval: null,
                selectedServers: [],
                showPassword: false,
                showAdvanced: false,
                testResult: {
                    status: '',
                    message: '',
                    success: false
                },
                importOptions: {
                    overwrite: false
                },
                importPreview: [],
                formErrors: {},
                toasts: [],
                toastTimeout: 3000
            }
        },
        computed: {
            isFormValid() {
                // 检查必填字段
                if (!this.serverForm.name || !this.serverForm.endpoint || 
                    !this.serverForm.port || !this.serverForm.uri) {
                    return false;
                }
                
                // 检查端口范围
                if (this.serverForm.port < 1024 || this.serverForm.port > 65535) {
                    return false;
                }
                
                // 如果不允许匿名访问，检查用户名和密码
                if (!this.serverForm.allow_anonymous) {
                    if (!this.serverForm.username || !this.serverForm.password) {
                        return false;
                    }
                }
                
                // 检查采样间隔
                if (this.serverForm.min_sampling_interval < 100) {
                    return false;
                }
                
                return true;
            }
        },
        methods: {
            async loadServers() {
                try {
                    const response = await fetch('/server/list/');
                    const data = await response.json();
                    if (data.success) {
                        this.servers = data.servers;
                    }
                } catch (error) {
                    console.error('Error loading servers:', error);
                    this.showError('加载服务器列表失败');
                }
            },

            async loadNodes() {
                if (!this.currentServer) return;
                
                this.isLoading = true;
                try {
                    const response = await fetch(`/node/list/?server_id=${this.currentServer.id}`);
                    const data = await response.json();
                    if (data.success) {
                        this.nodes = data.nodes;
                    }
                } catch (error) {
                    console.error('Error loading nodes:', error);
                    this.showError('加载节点列表失败');
                } finally {
                    this.isLoading = false;
                }
            },

            showServerModal(action, server = null) {
                this.serverAction = action;
                this.testResult = { status: '', message: '', success: false };
                
                if (action === 'edit' && server) {
                    // 编辑模式：复制服务器数据到表单
                    this.serverForm = {
                        id: server.id,
                        name: server.name,
                        endpoint: server.endpoint,
                        port: server.port,
                        uri: server.uri,
                        allow_anonymous: server.allow_anonymous,
                        username: server.username || '',
                        password: '',  // 出于安全考虑，不回显密码
                        min_sampling_interval: server.min_sampling_interval,
                        max_connections: server.max_connections || 0,
                        security_policy: server.security_policy || 'None'
                    };
                } else {
                    // 添加模式：重置表单
                    this.resetForm();
                }
                
                this.serverModal.show();
            },

            async handleServerAction() {
                if (this.isProcessing || !this.validateForm()) return;
                
                this.isProcessing = true;
                try {
                    const url = this.serverAction === 'add' 
                        ? '/server/add/'
                        : `/server/${this.serverForm.id}/edit/`;
                    
                    // 创建要发送的数据对象
                    const formData = { ...this.serverForm };
                    
                    // 如果是编辑模式且密码为空，则不发送密码字段
                    if (this.serverAction === 'edit' && !formData.password) {
                        delete formData.password;
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify(formData)
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        this.showSuccess(
                            this.serverAction === 'add' 
                                ? '服务器添加成功' 
                                : '服务器配置已更新'
                        );
                        this.serverModal.hide();
                        await this.loadServers();
                        this.resetForm();
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error handling server action:', error);
                    this.showError('操作失败');
                } finally {
                    this.isProcessing = false;
                }
            },

            async startServer(server) {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    const response = await fetch(`/server/${server.id}/start/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        server.is_running = true;
                        this.showSuccess('服务器已启动');
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error starting server:', error);
                    this.showError('启动服务器失败');
                } finally {
                    this.isProcessing = false;
                }
            },

            async stopServer(server) {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    const response = await fetch(`/server/${server.id}/stop/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        server.is_running = false;
                        this.showSuccess('服务器已停止');
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error stopping server:', error);
                    this.showError('停止服务器失败');
                } finally {
                    this.isProcessing = false;
                }
            },

            confirmDeleteServer(server) {
                this.confirmDialog = {
                    title: '确认删除服务器',
                    message: `确定要删除服务器"${server.name}"吗？此操作不可恢复。`,
                    callback: () => this.deleteServer(server)
                };
                this.confirmModal.show();
            },

            async deleteServer(server) {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    const response = await fetch(`/server/${server.id}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': this.getCsrfToken()
                        }
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        if (this.currentServer?.id === server.id) {
                            this.currentServer = null;
                        }
                        await this.loadServers();
                        this.showSuccess('服务器已删除');
                        this.confirmModal.hide();
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error deleting server:', error);
                    this.showError('删除服务器失败');
                } finally {
                    this.isProcessing = false;
                }
            },

            selectServer(server) {
                this.currentServer = server;
                this.loadNodes();
            },

            async refreshServers() {
                await this.loadServers();
                if (this.currentServer) {
                    const server = this.servers.find(s => s.id === this.currentServer.id);
                    if (server) {
                        this.currentServer = server;
                    }
                }
            },

            refreshNodes() {
                this.loadNodes();
            },

            startAutoRefresh() {
                this.stopAutoRefresh();
                this.refreshInterval = setInterval(async () => {
                    await this.refreshServers();
                    if (this.currentServer?.is_running) {
                        await this.loadNodes();
                    }
                }, 5000);
            },

            stopAutoRefresh() {
                if (this.refreshInterval) {
                    clearInterval(this.refreshInterval);
                    this.refreshInterval = null;
                }
            },

            handleConfirm() {
                if (this.confirmDialog.callback) {
                    this.confirmDialog.callback();
                }
            },

            showSuccess(message) {
                this.addToast({
                    type: 'success',
                    message: message
                });
            },

            showError(message) {
                this.addToast({
                    type: 'error',
                    message: message
                });
            },

            addToast(toast) {
                toast.show = true;
                this.toasts.push(toast);
                
                // 只有成功提示会自动消失
                if (toast.type === 'success') {
                    setTimeout(() => {
                        this.removeToast(this.toasts.indexOf(toast));
                    }, this.toastTimeout);
                }
            },

            removeToast(index) {
                if (index > -1) {
                    this.toasts.splice(index, 1);
                }
            },

            getCsrfToken() {
                const name = 'csrftoken';
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            },

            getNodeTypeDisplay(type) {
                const types = {
                    'variable': '变量',
                    'object': '对象',
                    'method': '方法'
                };
                return types[type] || type;
            },

            getDataTypeDisplay(type) {
                const types = {
                    'double': '双精度浮点数',
                    'float': '单精度浮点数',
                    'int32': '32位整数',
                    'int64': '64位整数',
                    'uint32': '32位无符号整数',
                    'uint64': '64位无符号整数',
                    'boolean': '布尔值',
                    'string': '字符串',
                    'datetime': '日期时间',
                    'bytestring': '字节串'
                };
                return types[type] || type;
            },

            getVariationTypeDisplay(type) {
                const types = {
                    'none': '无变化',
                    'random': '随机变化',
                    'increment': '递增',
                    'decrement': '递减',
                    'sine': '正弦波',
                    'square': '方波',
                    'triangle': '三角波',
                    'sawtooth': '锯齿波',
                    'discrete': '离散值'
                };
                return types[type] || type;
            },

            formatNodeValue(node) {
                if (!node.value && node.value !== 0) return '-';
                
                switch (node.data_type) {
                    case 'double':
                    case 'float':
                        const value = parseFloat(node.value);
                        return isNaN(value) ? '-' : value.toFixed(node.decimal_places || 2);
                    case 'boolean':
                        return node.value ? '是' : '否';
                    case 'datetime':
                        try {
                            return new Date(node.value).toLocaleString('zh-CN');
                        } catch {
                            return node.value;
                        }
                    default:
                        return node.value.toString();
                }
            },

            updateSelectedServers() {
                this.selectedServers = this.servers.filter(s => s.selected);
            },

            async batchStartServers() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    for (const server of this.selectedServers) {
                        if (!server.is_running) {
                            await this.startServer(server);
                        }
                    }
                    this.showSuccess('批量启动完成');
                } catch (error) {
                    console.error('Error in batch start:', error);
                    this.showError('批量启动过程中出现错误');
                } finally {
                    this.isProcessing = false;
                }
            },

            async batchStopServers() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    for (const server of this.selectedServers) {
                        if (server.is_running) {
                            await this.stopServer(server);
                        }
                    }
                    this.showSuccess('批量停止完成');
                } catch (error) {
                    console.error('Error in batch stop:', error);
                    this.showError('批量停止过程中出现错误');
                } finally {
                    this.isProcessing = false;
                }
            },

            confirmBatchDelete() {
                this.confirmDialog = {
                    title: '确认批量删除',
                    message: `确定要删除选中的 ${this.selectedServers.length} 个服务器吗��此操作不可恢复。`,
                    callback: () => this.batchDeleteServers()
                };
                this.confirmModal.show();
            },

            async batchDeleteServers() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    for (const server of this.selectedServers) {
                        if (!server.is_running) {
                            await this.deleteServer(server);
                        }
                    }
                    this.showSuccess('批量删除完成');
                    this.confirmModal.hide();
                } catch (error) {
                    console.error('Error in batch delete:', error);
                    this.showError('批量删除过程中出现错误');
                } finally {
                    this.isProcessing = false;
                }
            },

            async testConnection() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                this.testResult = { status: '', message: '', success: false };
                
                try {
                    const response = await fetch('/server/test-connection/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            ...this.serverForm,
                            mode: this.serverAction,  // 添加模式信息
                            original_id: this.serverAction === 'edit' ? this.serverForm.id : null  // 添加原始ID
                        })
                    });
                    
                    const data = await response.json();
                    this.testResult = {
                        status: data.success ? 'success' : 'error',
                        message: data.message,
                        success: data.success
                    };
                } catch (error) {
                    console.error('Error testing connection:', error);
                    this.testResult = {
                        status: 'error',
                        message: '连接测试失败',
                        success: false
                    };
                } finally {
                    this.isProcessing = false;
                }
            },

            showImportModal() {
                this.importPreview = [];
                this.importOptions.overwrite = false;
                this.importModal.show();
            },

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const content = await file.text();
                    const config = JSON.parse(content);
                    
                    // 验证配置文件格式
                    if (!Array.isArray(config)) {
                        throw new Error('无效的配置文件格式');
                    }
                    
                    // 生成导入预览
                    this.importPreview = await Promise.all(config.map(async server => ({
                        ...server,
                        exists: await this.checkServerExists(server.name)
                    })));
                } catch (error) {
                    console.error('Error parsing config file:', error);
                    this.showError('配置文件格式错误');
                    event.target.value = '';
                    this.importPreview = [];
                }
            },

            async checkServerExists(name) {
                return this.servers.some(s => s.name === name);
            },

            async importConfig() {
                if (this.isProcessing) return;
                
                this.isProcessing = true;
                try {
                    const response = await fetch('/server/import/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCsrfToken()
                        },
                        body: JSON.stringify({
                            servers: this.importPreview,
                            options: this.importOptions
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        await this.loadServers();
                        this.showSuccess('服务器配置导入成功');
                        this.importModal.hide();
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error importing config:', error);
                    this.showError('导入配置失败');
                } finally {
                    this.isProcessing = false;
                }
            },

            async exportConfig() {
                try {
                    const response = await fetch('/server/export/');
                    const data = await response.json();
                    
                    if (data.success) {
                        // 创建下载链接
                        const blob = new Blob([JSON.stringify(data.config, null, 2)], 
                                           { type: 'application/json' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'opcua_servers_config.json';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        this.showError(data.error);
                    }
                } catch (error) {
                    console.error('Error exporting config:', error);
                    this.showError('导出配置失败');
                }
            },

            validateForm() {
                this.formErrors = {};
                let isValid = true;
                
                // 验证服务器名称
                if (!this.serverForm.name) {
                    this.formErrors.name = '���输入服务器名称';
                    isValid = false;
                }
                
                // 验证终端点
                if (!this.serverForm.endpoint) {
                    this.formErrors.endpoint = '请输入终端点';
                    isValid = false;
                }
                
                // 验证端口号
                if (!this.serverForm.port) {
                    this.formErrors.port = '请输入端口号';
                    isValid = false;
                } else if (this.serverForm.port < 1024 || this.serverForm.port > 65535) {
                    this.formErrors.port = '端口号必须在1024-65535之间';
                    isValid = false;
                }
                
                // 验证URI
                if (!this.serverForm.uri) {
                    this.formErrors.uri = '请输入服务器URI';
                    isValid = false;
                } else if (!this.serverForm.uri.startsWith('urn:')) {
                    this.formErrors.uri = 'URI必须以"urn:"开头';
                    isValid = false;
                }
                
                // 如果允许匿名访问，验证用户名和密码
                if (!this.serverForm.allow_anonymous) {
                    if (!this.serverForm.username) {
                        this.formErrors.username = '请输入用户名';
                        isValid = false;
                    }
                    // 只在添加模式或编辑模式下有输入密码时验证密码
                    if (this.serverAction === 'add' || this.serverForm.password) {
                        if (!this.serverForm.password) {
                            this.formErrors.password = '请输入密码';
                            isValid = false;
                        }
                    }
                }
                
                return isValid;
            },

            resetForm() {
                this.serverForm = {
                    id: null,
                    name: '',
                    endpoint: '',
                    port: 4840,
                    uri: '',
                    allow_anonymous: true,
                    username: '',
                    password: '',
                    min_sampling_interval: 100,
                    max_connections: 0,
                    security_policy: 'None'
                };
                this.formErrors = {};
                this.testResult = {
                    status: '',
                    message: '',
                    success: false
                };
            }
        },
        async mounted() {
            // 初始化Bootstrap模态框
            this.serverModal = new bootstrap.Modal(this.$refs.serverModal);
            this.confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            this.importModal = new bootstrap.Modal(this.$refs.importModal);
            
            // 加载服务器列表
            await this.loadServers();
            
            // 启动自动刷新
            this.startAutoRefresh();
        },
        beforeUnmount() {
            this.stopAutoRefresh();
        }
    }).mount('#app');
</script>
{% endblock %} 